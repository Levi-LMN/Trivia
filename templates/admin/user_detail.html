{% extends 'admin/base.html' %}
{% block page_title %}{{ user.name }}{% endblock %}
{% block breadcrumb %}
<nav class="text-xs text-slate-400 mt-0.5">
  <a href="{{ url_for('admin_users') }}" class="hover:text-slate-600">Users</a>
  <span class="mx-1">â€º</span>
  <span class="text-slate-600">{{ user.name }}</span>
</nav>
{% endblock %}

{% block content %}
<!-- User info card -->
<div class="grid lg:grid-cols-3 gap-6 mb-6">
  <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-5">
    <div class="flex items-center gap-4">
      <div class="w-14 h-14 rounded-xl bg-amber-100 text-amber-700 flex items-center justify-center text-2xl font-bold font-cinzel">
        {{ user.name[0]|upper }}
      </div>
      <div>
        <p class="font-semibold text-slate-800 text-lg">{{ user.name }}</p>
        <p class="text-slate-400 text-sm font-mono">{{ user.phone }}</p>
        <p class="text-slate-400 text-xs mt-0.5">Joined {{ user.created_at[:10] }}</p>
      </div>
    </div>
  </div>

  <div class="lg:col-span-2 grid grid-cols-3 gap-3">
    {% set total_pts = sessions_data | sum(attribute='total_points') or 0 %}
    {% set total_correct = sessions_data | sum(attribute='correct_count') or 0 %}
    {% for label, val, cls in [
      ('Total Points', total_pts, 'bg-amber-50 text-amber-700'),
      ('Correct Answers', total_correct, 'bg-green-50 text-green-700'),
      ('Sessions Taken', sessions_data|length, 'bg-blue-50 text-blue-700'),
    ] %}
    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 text-center">
      <p class="text-3xl font-bold {{ cls }} rounded-xl py-2">{{ val }}</p>
      <p class="text-xs text-slate-400 mt-1 font-medium">{{ label }}</p>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Sessions breakdown -->
<div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden mb-6">
  <div class="px-5 py-4 border-b border-slate-100">
    <h3 class="font-semibold text-slate-700">Session Results</h3>
  </div>
  {% if sessions_data %}
  <div class="overflow-x-auto">
    <table class="w-full text-sm">
      <thead class="bg-slate-50">
        <tr>
          <th class="text-left px-4 py-2.5 text-slate-400 font-medium">Session</th>
          <th class="text-center px-4 py-2.5 text-slate-400 font-medium">Answered</th>
          <th class="text-center px-4 py-2.5 text-slate-400 font-medium">Correct</th>
          <th class="text-center px-4 py-2.5 text-slate-400 font-medium">Score</th>
          <th class="text-center px-4 py-2.5 text-slate-400 font-medium">Points</th>
          <th class="text-left px-4 py-2.5 text-slate-400 font-medium">Status</th>
        </tr>
      </thead>
      <tbody>
        {% for s in sessions_data %}
        {% set pct = ((s.correct_count / s.total_answered) * 100)|int if s.total_answered and s.total_answered > 0 else 0 %}
        <tr class="border-t border-slate-50 hover:bg-slate-50">
          <td class="px-4 py-3 font-medium text-slate-800">{{ s.session_name }}</td>
          <td class="px-4 py-3 text-center text-slate-500">{{ s.total_answered or 0 }}/{{ s.total_questions or '?' }}</td>
          <td class="px-4 py-3 text-center text-green-600 font-semibold">{{ s.correct_count or 0 }}</td>
          <td class="px-4 py-3 text-center">
            <span class="{% if pct >= 80 %}text-green-600{% elif pct >= 50 %}text-amber-600{% else %}text-red-500{% endif %} font-semibold">{{ pct }}%</span>
          </td>
          <td class="px-4 py-3 text-center">
            <span class="bg-amber-100 text-amber-800 font-bold px-2 py-0.5 rounded-full text-xs">{{ s.total_points or 0 }}</span>
          </td>
          <td class="px-4 py-3">
            {% if s.completed_at %}
              <span class="bg-green-100 text-green-700 text-xs px-2 py-0.5 rounded-full">Completed</span>
            {% else %}
              <span class="bg-amber-100 text-amber-700 text-xs px-2 py-0.5 rounded-full">In Progress</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p class="px-5 py-8 text-center text-slate-400 text-sm">No session attempts yet</p>
  {% endif %}
</div>

{% if codes %}
<div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden mb-6">
  <div class="px-5 py-4 border-b border-slate-100">
    <h3 class="font-semibold text-slate-700">ğŸ Reward Codes Earned ({{ codes|length }})</h3>
  </div>
  <div class="p-4 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3">
    {% for c in codes %}
    <div class="bg-amber-50 border border-amber-100 rounded-xl p-3 text-center">
      <p class="font-mono font-bold text-amber-800 tracking-widest text-base">{{ c.reward_code }}</p>
      <p class="text-xs text-slate-400 mt-1 truncate" title="{{ c.question_text }}">{{ c.session_name }}</p>
      <p class="text-xs text-slate-300">{{ c.answered_at[:10] }}</p>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- Cheat flags -->
{% if cheat_flags %}
<div class="bg-white rounded-2xl shadow-sm border border-red-100 overflow-hidden">
  <div class="px-5 py-4 border-b border-red-100 flex items-center gap-2">
    <span class="text-lg">ğŸš©</span>
    <h3 class="font-semibold text-red-700">Integrity Flags ({{ cheat_flags|length }})</h3>
    <span class="ml-auto text-xs text-slate-400">Most recent 50</span>
  </div>
  <div class="overflow-x-auto">
    <table class="w-full text-xs">
      <thead class="bg-red-50">
        <tr>
          <th class="text-left px-4 py-2 text-red-400 font-medium">Type</th>
          <th class="text-left px-4 py-2 text-red-400 font-medium">Session</th>
          <th class="text-left px-4 py-2 text-red-400 font-medium">Time</th>
        </tr>
      </thead>
      <tbody>
        {% for f in cheat_flags %}
        {% set icon = {'tab_switch':'ğŸ”€','window_blur':'ğŸªŸ','copy_attempt':'ğŸ“‹','right_click':'ğŸ–±','keyboard_shortcut':'âŒ¨ï¸','devtools':'ğŸ”§','context_menu':'ğŸ“‹','auto_submit':'ğŸš¨','unknown':'â“'} %}
        <tr class="border-t border-red-50 hover:bg-red-50">
          <td class="px-4 py-2">
            <span class="inline-flex items-center gap-1.5 bg-red-100 text-red-700 px-2 py-0.5 rounded-full font-medium">
              {{ icon.get(f.violation_type, 'â“') }} {{ f.violation_type.replace('_', ' ').title() }}
            </span>
          </td>
          <td class="px-4 py-2 text-slate-500">{{ f.session_name }}</td>
          <td class="px-4 py-2 text-slate-400 font-mono">{{ f.flagged_at[:16] }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}
{% endblock %}