{% extends 'admin/base.html' %}
{% block page_title %}Manage Sessions{% endblock %}

{% block content %}
<div class="grid lg:grid-cols-3 gap-4 sm:gap-6">

  <!-- Create session form -->
  <div class="lg:col-span-1">
    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 sm:p-5 lg:sticky lg:top-4">
      <h2 class="font-semibold text-slate-700 mb-4">+ New Session</h2>
      <form method="POST" class="space-y-3">
        <input type="hidden" name="action" value="create"/>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Session Name *</label>
          <input type="text" name="name" required placeholder="e.g. New Testament Basics"
                 class="w-full px-3 py-2 rounded-lg border border-slate-200 focus:border-amber-400 focus:outline-none text-sm"/>
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Description</label>
          <textarea name="description" rows="2" placeholder="Optional description..."
                    class="w-full px-3 py-2 rounded-lg border border-slate-200 focus:border-amber-400 focus:outline-none text-sm resize-none"></textarea>
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">‚è± Time Limit <span class="text-slate-400">(minutes, 0 = no limit)</span></label>
          <div class="flex items-center gap-2">
            <input type="number" name="time_limit_minutes" min="0" max="999" value="0"
                   class="w-24 px-3 py-2 rounded-lg border border-slate-200 focus:border-amber-400 focus:outline-none text-sm"/>
            <span class="text-xs text-slate-400">mins</span>
          </div>
          <p class="text-xs text-slate-400 mt-1">Users see a live countdown. Auto-submits when time is up.</p>
        </div>
        <label class="flex items-center gap-2 cursor-pointer pt-1">
          <input type="checkbox" name="randomize" checked class="rounded border-slate-300 text-amber-600"/>
          <span class="text-sm text-slate-600">Randomize question order</span>
        </label>
        <button type="submit" class="w-full bg-amber-700 hover:bg-amber-600 text-white py-2 rounded-lg font-medium text-sm transition">
          Create Session
        </button>
      </form>
    </div>
  </div>

  <!-- Sessions list -->
  <div class="lg:col-span-2 space-y-3">
    {% for s in sessions %}
    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
      <div class="p-3 sm:p-4">
        <div class="flex items-start gap-3">
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-1.5 flex-wrap">
              <span class="font-semibold text-slate-800 text-sm sm:text-base">{{ s.name }}</span>
              <span class="text-xs px-2 py-0.5 rounded-full font-medium {% if s.is_active %}bg-green-100 text-green-700{% else %}bg-slate-100 text-slate-500{% endif %}">
                {% if s.is_active %}‚óè Active{% else %}‚óã Inactive{% endif %}
              </span>
              <span class="text-xs px-2 py-0.5 rounded-full font-medium {% if s.randomize_questions %}bg-purple-100 text-purple-700{% else %}bg-slate-100 text-slate-500{% endif %}">
                {% if s.randomize_questions %}üîÄ Random{% else %}üìã Ordered{% endif %}
              </span>
              {% if s.time_limit_minutes and s.time_limit_minutes > 0 %}
              <span class="text-xs px-2 py-0.5 rounded-full font-medium bg-orange-100 text-orange-700">‚è± {{ s.time_limit_minutes }} min</span>
              {% else %}
              <span class="text-xs px-2 py-0.5 rounded-full font-medium bg-slate-100 text-slate-400">‚è± No limit</span>
              {% endif %}
            </div>
            {% if s.description %}
              <p class="text-xs text-slate-400 mt-0.5">{{ s.description }}</p>
            {% endif %}
            <div class="flex flex-wrap gap-3 mt-1.5 text-xs text-slate-400">
              <span>{{ s.section_count }} sections</span>
              <span>{{ s.question_count }} questions</span>
              <span>{{ s.participant_count }} participants</span>
            </div>
          </div>
        </div>

        <!-- Actions row (wraps nicely on mobile) -->
        <div class="flex flex-wrap gap-1.5 mt-3">
          <a href="{{ url_for('admin_sections', session_id=s.id) }}"
             class="bg-blue-50 hover:bg-blue-100 text-blue-700 text-xs px-3 py-1.5 rounded-lg font-medium transition">
            Sections ‚Üí
          </a>
          <form method="POST" class="inline">
            <input type="hidden" name="action" value="toggle_active"/>
            <input type="hidden" name="sid" value="{{ s.id }}"/>
            <button type="submit" class="{% if s.is_active %}bg-yellow-50 hover:bg-yellow-100 text-yellow-700{% else %}bg-green-50 hover:bg-green-100 text-green-700{% endif %} text-xs px-3 py-1.5 rounded-lg font-medium transition">
              {% if s.is_active %}Deactivate{% else %}Activate{% endif %}
            </button>
          </form>
          <form method="POST" class="inline">
            <input type="hidden" name="action" value="toggle_randomize"/>
            <input type="hidden" name="sid" value="{{ s.id }}"/>
            <button type="submit" class="bg-purple-50 hover:bg-purple-100 text-purple-700 text-xs px-3 py-1.5 rounded-lg font-medium transition">
              {% if s.randomize_questions %}üîÄ On{% else %}üìã Off{% endif %}
            </button>
          </form>
          <button onclick="openEditTimer({{ s.id }}, '{{ s.name }}', '{{ s.description or '' }}', {{ s.time_limit_minutes or 0 }})"
                  class="bg-orange-50 hover:bg-orange-100 text-orange-700 text-xs px-3 py-1.5 rounded-lg font-medium transition">
            ‚è± Edit
          </button>
          <form method="POST" class="inline" onsubmit="return confirm('Delete this session and all its content?')">
            <input type="hidden" name="action" value="delete"/>
            <input type="hidden" name="sid" value="{{ s.id }}"/>
            <button type="submit" class="bg-red-50 hover:bg-red-100 text-red-600 text-xs px-3 py-1.5 rounded-lg font-medium transition">
              Delete
            </button>
          </form>
        </div>
      </div>
    </div>
    {% else %}
    <div class="text-center py-16 text-slate-400">
      <div class="text-5xl mb-3">üóÇ</div>
      <p>No sessions yet. Create one!</p>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Edit Modal -->
<div id="edit-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-5 sm:p-6 max-h-[90vh] overflow-y-auto">
    <h3 class="font-semibold text-slate-800 text-lg mb-4">Edit Session</h3>
    <form method="POST" class="space-y-4">
      <input type="hidden" name="action" value="edit"/>
      <input type="hidden" name="sid" id="edit-sid"/>
      <div>
        <label class="block text-xs font-medium text-slate-600 mb-1">Session Name *</label>
        <input type="text" name="name" id="edit-name" required
               class="w-full px-3 py-2 rounded-lg border border-slate-200 focus:border-amber-400 focus:outline-none text-sm"/>
      </div>
      <div>
        <label class="block text-xs font-medium text-slate-600 mb-1">Description</label>
        <textarea name="description" id="edit-desc" rows="2"
                  class="w-full px-3 py-2 rounded-lg border border-slate-200 focus:border-amber-400 focus:outline-none text-sm resize-none"></textarea>
      </div>
      <div>
        <label class="block text-xs font-semibold text-slate-700 mb-2">‚è± Time Limit</label>
        <div class="grid grid-cols-4 gap-1.5 sm:gap-2 mb-3" id="preset-btns">
          {% for mins, label in [(0,'None'),(10,'10m'),(20,'20m'),(30,'30m'),(45,'45m'),(60,'1h'),(90,'1.5h'),(120,'2h')] %}
          <button type="button" onclick="setTimerPreset({{ mins }})" data-mins="{{ mins }}"
                  class="preset-btn text-xs py-1.5 rounded-lg border font-medium transition border-slate-200 bg-slate-50 hover:bg-orange-50 hover:border-orange-300 hover:text-orange-700 text-slate-600">
            {{ label }}
          </button>
          {% endfor %}
        </div>
        <div class="flex items-center gap-2">
          <label class="text-xs text-slate-500">Custom:</label>
          <input type="number" name="time_limit_minutes" id="edit-timer" min="0" max="999" value="0"
                 class="w-20 px-3 py-2 rounded-lg border border-slate-200 focus:border-orange-400 focus:outline-none text-sm"
                 oninput="highlightPreset(this.value)"/>
          <span class="text-xs text-slate-400">minutes</span>
        </div>
      </div>
      <div class="flex gap-3 pt-2">
        <button type="submit" class="flex-1 bg-amber-700 hover:bg-amber-600 text-white py-2 rounded-lg font-medium text-sm transition">Save Changes</button>
        <button type="button" onclick="closeEditModal()" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg text-sm transition">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
function openEditTimer(sid, name, desc, timer) {
  document.getElementById('edit-sid').value = sid;
  document.getElementById('edit-name').value = name;
  document.getElementById('edit-desc').value = desc;
  document.getElementById('edit-timer').value = timer;
  highlightPreset(timer);
  document.getElementById('edit-modal').classList.remove('hidden');
}
function closeEditModal() {
  document.getElementById('edit-modal').classList.add('hidden');
}
function setTimerPreset(mins) {
  document.getElementById('edit-timer').value = mins;
  highlightPreset(mins);
}
function highlightPreset(val) {
  document.querySelectorAll('.preset-btn').forEach(btn => {
    const match = parseInt(btn.dataset.mins) === parseInt(val);
    btn.classList.toggle('bg-orange-100', match);
    btn.classList.toggle('border-orange-400', match);
    btn.classList.toggle('text-orange-700', match);
    btn.classList.toggle('bg-slate-50', !match);
    btn.classList.toggle('border-slate-200', !match);
    btn.classList.toggle('text-slate-600', !match);
  });
}
document.getElementById('edit-modal').addEventListener('click', function(e) {
  if (e.target === this) closeEditModal();
});
</script>
{% endblock %}