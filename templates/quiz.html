{% extends 'base.html' %}
{% block title %}{{ quiz_session.name }} ‚Äì Bible Trivia{% endblock %}

{% block head %}
<style>
  @keyframes pulse-red { 0%,100%{opacity:1} 50%{opacity:.4} }
  .timer-critical { animation: pulse-red 1s infinite; }
</style>
{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto px-3 sm:px-4 py-4 sm:py-8">

  <!-- ‚îÄ‚îÄ Timer bar (only when time limit is set) ‚îÄ‚îÄ -->
  {% if remaining_seconds is not none %}
  <div class="mb-4">
    <div class="flex items-center justify-between mb-1.5">
      <span class="text-xs text-stone-400 uppercase tracking-widest truncate mr-2">{{ quiz_session.name }}</span>
      <div id="timer-display"
           class="flex items-center gap-1.5 bg-white border-2 border-amber-200 rounded-xl px-2.5 py-1.5 shadow-sm transition-colors flex-shrink-0">
        <span class="text-sm" id="timer-icon">‚è±</span>
        <span id="timer-text" class="font-mono font-bold text-amber-800 text-sm tabular-nums tracking-widest">--:--</span>
      </div>
    </div>
    <div class="w-full bg-amber-100 rounded-full h-2 overflow-hidden">
      <div id="timer-bar" class="h-2 rounded-full transition-colors duration-1000" style="background:#b45309; width:100%;"></div>
    </div>
  </div>
  <form id="expire-form" method="POST" action="{{ url_for('expire_quiz', session_id=quiz_session.id) }}" class="hidden"></form>
  {% else %}
  <div class="mb-4 flex items-center justify-between">
    <span class="text-xs text-stone-400 uppercase tracking-widest">{{ quiz_session.name }}</span>
    <span class="text-xs text-stone-400">{% if question.section_name %}{{ question.section_name }}{% endif %}</span>
  </div>
  {% endif %}

  <!-- ‚îÄ‚îÄ Question progress bar ‚îÄ‚îÄ -->
  <div class="mb-4 sm:mb-6">
    <div class="flex items-center justify-between mb-1.5">
      <span class="text-xs font-medium text-stone-500 truncate mr-2">
        {% if question.section_name %}{{ question.section_name }} ¬∑ {% endif %}Question {{ progress + 1 }}
      </span>
      <span class="text-xs font-semibold text-stone-500 flex-shrink-0">{{ progress }}/{{ total }}</span>
    </div>
    <div class="w-full bg-amber-100 rounded-full h-2">
      {% set pct = (progress / total * 100) | int if total > 0 else 0 %}
      <div class="bg-amber-700 h-2 rounded-full transition-all duration-500" style="width: {{ pct }}%"></div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Question card ‚îÄ‚îÄ -->
  {% set qtype = question.question_type or 'single' %}
  <div class="bg-white rounded-2xl shadow-lg border border-amber-100 overflow-hidden mb-4 sm:mb-5">

    <!-- Card header -->
    <div class="bg-amber-800 px-4 sm:px-5 py-2.5 sm:py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        {% if qtype == 'multi' %}
          <span class="bg-purple-500/30 text-purple-200 text-xs px-2 py-0.5 rounded-full font-medium">‚òë Select all that apply</span>
        {% elif qtype == 'fill_blank' %}
          <span class="bg-blue-500/30 text-blue-200 text-xs px-2 py-0.5 rounded-full font-medium">‚úè Fill in the blanks</span>
        {% else %}
          <span class="text-amber-300 text-xs font-medium uppercase tracking-widest">Single Choice</span>
        {% endif %}
      </div>
      <span class="bg-yellow-500/20 text-yellow-200 text-xs font-bold px-2.5 py-1 rounded-full flex-shrink-0">
        ‚ú¶ {{ question.points }} pt{% if question.points != 1 %}s{% endif %}
      </span>
    </div>

    <!-- ‚ïê‚ïê‚ïê FILL IN THE BLANK ‚ïê‚ïê‚ïê -->
    {% if qtype == 'fill_blank' %}
      {% set blank_opts = json.loads(question.blank_options or '[]') %}
      <form method="POST" id="answer-form" class="p-4 sm:p-6">
        <input type="hidden" name="question_id" value="{{ question.id }}"/>
        <p class="text-stone-400 text-sm mb-4 text-center italic">Choose an option for each blank to complete the sentence</p>
        <div class="font-cinzel text-base sm:text-lg text-amber-950 leading-loose text-center bg-amber-50 rounded-xl px-4 sm:px-5 py-4 sm:py-5 border border-amber-100">
          {% set parts = question.question_text.split('___') %}
          {% for part in parts %}{{ part }}{% if not loop.last %}{% set bi = loop.index0 %}{% if bi < blank_opts|length %}<select name="blank_{{ bi }}" class="blank-select inline-block border-b-2 border-amber-600 bg-white hover:bg-amber-50 text-amber-900 font-semibold px-1.5 py-1 mx-1 rounded-lg text-xs sm:text-sm focus:outline-none focus:border-amber-800 transition cursor-pointer" required onchange="checkFillBlanks()"><option value="">choose‚Ä¶</option>{% for opt in blank_opts[bi] %}<option value="{{ opt }}">{{ opt }}</option>{% endfor %}</select>{% endif %}{% endif %}{% endfor %}
        </div>
        <div class="pt-4 sm:pt-5">
          <button type="submit" id="submit-btn"
                  class="w-full bg-amber-800 hover:bg-amber-700 text-amber-50 font-semibold py-3 sm:py-3.5 rounded-xl text-base sm:text-lg font-cinzel tracking-wide transition shadow disabled:opacity-40 disabled:cursor-not-allowed" disabled>
            Submit Answer ‚Üí
          </button>
        </div>
      </form>

    <!-- ‚ïê‚ïê‚ïê MULTI-SELECT ‚ïê‚ïê‚ïê -->
    {% elif qtype == 'multi' %}
      <div class="px-4 sm:px-6 pt-5 sm:pt-6 pb-3">
        <p class="font-cinzel text-lg sm:text-xl font-semibold text-amber-950 leading-relaxed text-center py-2">{{ question.question_text }}</p>
      </div>
      <form method="POST" id="answer-form" class="px-4 sm:px-6 pb-5 sm:pb-6 space-y-2.5 sm:space-y-3 pt-3" onsubmit="return validateMulti()">
        <input type="hidden" name="question_id" value="{{ question.id }}"/>
        {% for letter, text in [('A', question.option_a),('B', question.option_b),('C', question.option_c),('D', question.option_d)] %}
          {% if text %}
          <label class="flex items-center gap-3 sm:gap-4 p-3 sm:p-4 rounded-xl border-2 border-amber-100 hover:border-amber-400 hover:bg-amber-50 cursor-pointer transition group">
            <input type="checkbox" name="answer" value="{{ letter }}" class="multi-check w-4 h-4 sm:w-5 sm:h-5 rounded border-2 border-amber-300 accent-amber-700 flex-shrink-0" onchange="checkMulti()"/>
            <div class="flex-shrink-0 w-8 h-8 sm:w-9 sm:h-9 rounded-full border-2 border-amber-200 flex items-center justify-center font-cinzel font-bold text-xs sm:text-sm text-amber-600 transition">{{ letter }}</div>
            <span class="text-stone-700 font-medium flex-1 text-sm sm:text-base">{{ text }}</span>
          </label>
          {% endif %}
        {% endfor %}
        <div class="pt-2">
          <button type="submit" id="submit-btn"
                  class="w-full bg-amber-800 hover:bg-amber-700 text-amber-50 font-semibold py-3 sm:py-3.5 rounded-xl text-base sm:text-lg font-cinzel tracking-wide transition shadow disabled:opacity-40 disabled:cursor-not-allowed" disabled>
            Submit Answer ‚Üí
          </button>
        </div>
      </form>

    <!-- ‚ïê‚ïê‚ïê SINGLE CHOICE ‚ïê‚ïê‚ïê -->
    {% else %}
      <div class="px-4 sm:px-6 pt-5 sm:pt-6 pb-3">
        <p class="font-cinzel text-lg sm:text-xl font-semibold text-amber-950 leading-relaxed text-center py-2">{{ question.question_text }}</p>
      </div>
      <form method="POST" id="answer-form" class="px-4 sm:px-6 pb-5 sm:pb-6 space-y-2.5 sm:space-y-3 pt-3">
        <input type="hidden" name="question_id" value="{{ question.id }}"/>
        {% for letter, text in [('A', question.option_a),('B', question.option_b),('C', question.option_c),('D', question.option_d)] %}
          {% if text %}
          <label class="flex items-center gap-3 sm:gap-4 p-3 sm:p-4 rounded-xl border-2 border-amber-100 hover:border-amber-400 hover:bg-amber-50 cursor-pointer transition group has-[:checked]:border-amber-700 has-[:checked]:bg-amber-50">
            <input type="radio" name="answer" value="{{ letter }}" class="sr-only" required
                   onchange="document.getElementById('submit-btn').disabled=false"/>
            <div class="flex-shrink-0 w-8 h-8 sm:w-9 sm:h-9 rounded-full border-2 border-amber-200 group-has-[:checked]:border-amber-700 group-has-[:checked]:bg-amber-700 flex items-center justify-center font-cinzel font-bold text-xs sm:text-sm text-amber-600 group-has-[:checked]:text-white transition">{{ letter }}</div>
            <span class="text-stone-700 font-medium flex-1 text-sm sm:text-base">{{ text }}</span>
          </label>
          {% endif %}
        {% endfor %}
        <div class="pt-2">
          <button type="submit" id="submit-btn"
                  class="w-full bg-amber-800 hover:bg-amber-700 text-amber-50 font-semibold py-3 sm:py-3.5 rounded-xl text-base sm:text-lg font-cinzel tracking-wide transition shadow disabled:opacity-40 disabled:cursor-not-allowed" disabled>
            Submit Answer ‚Üí
          </button>
        </div>
      </form>
    {% endif %}
  </div>

  <!-- Mini progress dots -->
  {% if all_questions|length > 1 %}
  <details class="bg-white rounded-xl border border-amber-100 shadow-sm">
    <summary class="px-4 sm:px-5 py-3 cursor-pointer text-xs sm:text-sm font-medium text-stone-600 hover:text-stone-800">
      All questions ({{ total }})
    </summary>
    <div class="px-4 sm:px-5 pb-4 grid grid-cols-8 sm:grid-cols-10 gap-1.5 pt-2">
      {% for q in all_questions %}
        {% if q.id in answered_ids %}
          {% if answered_map[q.id].is_correct %}
            <div class="w-7 h-7 sm:w-8 sm:h-8 rounded-lg bg-green-100 border border-green-300 flex items-center justify-center text-xs font-bold text-green-700">‚úì</div>
          {% else %}
            <div class="w-7 h-7 sm:w-8 sm:h-8 rounded-lg bg-red-100 border border-red-300 flex items-center justify-center text-xs font-bold text-red-700">‚úó</div>
          {% endif %}
        {% elif q.id == question.id %}
          <div class="w-7 h-7 sm:w-8 sm:h-8 rounded-lg bg-amber-700 border border-amber-600 flex items-center justify-center text-xs font-bold text-white">‚óè</div>
        {% else %}
          <div class="w-7 h-7 sm:w-8 sm:h-8 rounded-lg bg-amber-50 border border-amber-200 flex items-center justify-center text-xs text-stone-400">‚óã</div>
        {% endif %}
      {% endfor %}
    </div>
  </details>
  {% endif %}

  <div class="mt-4 text-center">
    <a href="{{ url_for('results') }}" class="text-amber-600 hover:text-amber-800 text-xs sm:text-sm underline">View my scores so far</a>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TIMER JAVASCRIPT ‚Äî syncs with backend every 30s
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
{% if remaining_seconds is not none %}
<script>
(function() {
  let remaining = {{ remaining_seconds }};
  const totalSecs = {{ time_limit }} * 60;
  const sessionId = {{ quiz_session.id }};

  const displayEl = document.getElementById('timer-display');
  const textEl    = document.getElementById('timer-text');
  const iconEl    = document.getElementById('timer-icon');
  const barEl     = document.getElementById('timer-bar');
  let expired     = false;

  function fmt(secs) {
    const m = Math.floor(Math.max(secs,0) / 60);
    const s = Math.max(secs,0) % 60;
    return String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
  }

  function updateBar(secs) {
    const pct = totalSecs > 0 ? Math.max((secs / totalSecs) * 100, 0) : 0;
    barEl.style.width = pct + '%';
    if (pct > 50)      barEl.style.background = '#15803d';
    else if (pct > 25) barEl.style.background = '#b45309';
    else if (pct > 10) barEl.style.background = '#c2410c';
    else               barEl.style.background = '#dc2626';
  }

  function updateDisplay(secs) {
    textEl.textContent = fmt(secs);
    updateBar(secs);
    if (secs <= 0) {
      iconEl.textContent = 'üî¥';
      displayEl.className = displayEl.className.replace(/border-\S+/g, '') + ' border-red-400 bg-red-50';
      textEl.classList.add('text-red-700','timer-critical');
      textEl.classList.remove('text-amber-800','text-orange-700');
    } else if (secs <= 30) {
      iconEl.textContent = 'üî¥';
      displayEl.classList.add('border-red-400','bg-red-50');
      displayEl.classList.remove('border-amber-200','border-orange-300');
      textEl.classList.add('text-red-700','timer-critical');
      textEl.classList.remove('text-orange-700','text-amber-800');
    } else if (secs <= 60) {
      iconEl.textContent = 'üü†';
      displayEl.classList.add('border-orange-300','bg-orange-50');
      displayEl.classList.remove('border-amber-200','border-red-400');
      textEl.classList.add('text-orange-700');
      textEl.classList.remove('text-amber-800','text-red-700','timer-critical');
    } else {
      iconEl.textContent = '‚è±';
      textEl.classList.remove('text-orange-700','text-red-700','timer-critical');
      textEl.classList.add('text-amber-800');
    }
  }

  function expire() {
    if (expired) return;
    expired = true;
    clearInterval(tickInterval);
    clearInterval(syncInterval);
    const btn = document.getElementById('submit-btn');
    if (btn) { btn.disabled = true; btn.textContent = '‚è∞ Time is up!'; }
    document.getElementById('expire-form').submit();
  }

  // ‚îÄ‚îÄ Backend sync every 30 seconds ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function syncWithBackend() {
    fetch('/api/timer/' + sessionId)
      .then(r => r.json())
      .then(data => {
        if (data.expired) { expire(); return; }
        if (data.remaining !== null) {
          // Correct our local countdown to match server truth
          remaining = data.remaining;
          updateDisplay(remaining);
        }
      })
      .catch(() => {}); // silent fail ‚Äî local countdown keeps going
  }

  // Initial render
  updateDisplay(remaining);

  // Local tick
  const tickInterval = setInterval(() => {
    remaining -= 1;
    updateDisplay(remaining);
    if (remaining <= 0) expire();
  }, 1000);

  // Server sync
  const syncInterval = setInterval(syncWithBackend, 30000);

  // Stop ticking when user submits an answer
  document.getElementById('answer-form')?.addEventListener('submit', () => {
    clearInterval(tickInterval);
    clearInterval(syncInterval);
  });
})();
</script>
{% endif %}

<script>
function checkMulti() {
  document.getElementById('submit-btn').disabled = !document.querySelectorAll('.multi-check:checked').length;
}
function validateMulti() {
  if (!document.querySelectorAll('.multi-check:checked').length) {
    alert('Please select at least one answer.'); return false;
  }
  return true;
}
function checkFillBlanks() {
  const selects = document.querySelectorAll('.blank-select');
  document.getElementById('submit-btn').disabled = [...selects].some(s => !s.value);
}
document.addEventListener('DOMContentLoaded', () => {
  if (document.querySelectorAll('.blank-select').length) checkFillBlanks();
});
</script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     ANTI-CHEAT SYSTEM v2
     Key fixes:
       ‚Ä¢ Single "lost focus" event via 300ms debounce ‚Äî prevents
         visibilitychange + blur firing as TWO strikes simultaneously
       ‚Ä¢ document.hasFocus() polling every 500ms as bulletproof backup
       ‚Ä¢ Strike count persisted in sessionStorage across question loads
       ‚Ä¢ Persistent strike badge always visible in the UI
       ‚Ä¢ Silent-log (right-click, copy) separated from warning-strikes
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- Persistent strike badge (top-right of screen) -->
<div id="ac-badge" class="hidden fixed top-4 right-4 z-[9998] flex items-center gap-1.5
     bg-red-600 text-white text-xs font-bold px-3 py-1.5 rounded-full shadow-lg">
  <span>‚ö†Ô∏è</span>
  <span id="ac-badge-text">0 / 3 strikes</span>
</div>

<!-- Warning overlay -->
<div id="ac-overlay" class="hidden fixed inset-0 z-[9999] flex items-center justify-center p-4"
     style="background:rgba(0,0,0,0.88);">
  <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full overflow-hidden">
    <div class="bg-red-600 px-5 py-4 flex items-center gap-3">
      <span class="text-3xl">‚ö†Ô∏è</span>
      <div>
        <h2 class="font-cinzel font-bold text-white text-lg leading-tight">Focus Warning</h2>
        <p class="text-red-100 text-xs">Integrity violation detected</p>
      </div>
    </div>
    <div class="px-5 py-5">
      <p id="ac-warning-msg" class="text-slate-700 text-sm leading-relaxed mb-1">
        You left the quiz window. This has been recorded.
      </p>
      <p id="ac-strike-msg" class="text-red-600 font-bold text-sm mb-4"></p>
      <button id="ac-dismiss"
              class="w-full bg-amber-800 hover:bg-amber-700 text-white font-semibold py-2.5 rounded-xl transition text-sm">
        I understand ‚Äì Return to Quiz
      </button>
    </div>
  </div>
</div>

<!-- Auto-submit countdown overlay -->
<div id="ac-autosubmit" class="hidden fixed inset-0 z-[9999] flex items-center justify-center p-4"
     style="background:rgba(0,0,0,0.95);">
  <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full overflow-hidden text-center">
    <div class="bg-red-700 px-5 py-5">
      <span class="text-5xl">üö®</span>
      <h2 class="font-cinzel font-bold text-white text-xl mt-2">Too Many Violations</h2>
    </div>
    <div class="px-5 py-6">
      <p class="text-slate-700 text-sm mb-1">Multiple integrity violations were detected.</p>
      <p class="text-slate-700 text-sm mb-4">Your quiz is being submitted in</p>
      <div id="ac-countdown" class="text-7xl font-bold text-red-600 font-mono mb-4">5</div>
      <p class="text-xs text-slate-400">Your answers so far will be saved.</p>
    </div>
  </div>
</div>

<style>
  /* Prevent all text selection outside form controls */
  body * { -webkit-user-select: none; -moz-user-select: none; user-select: none; }
  input, textarea, select, [contenteditable] {
    -webkit-user-select: text; -moz-user-select: text; user-select: text;
  }
  @media print { body { display: none !important; } }
</style>

<script>
(function () {
  'use strict';

  /* ‚îÄ‚îÄ Configuration ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  const SESSION_ID   = {{ quiz_session.id }};
  const MAX_STRIKES  = 3;
  const DEBOUNCE_MS  = 300;   // window to collapse duplicate events into 1 strike
  const GRACE_MS     = 1500;  // ignore blur events this many ms after page load
  const POLL_MS      = 500;   // hasFocus() polling interval

  /* ‚îÄ‚îÄ State ‚Äî restored from sessionStorage so strikes survive page reloads ‚îÄ‚îÄ */
  const STORE_KEY = 'ac_strikes_' + SESSION_ID;
  let strikes        = parseInt(sessionStorage.getItem(STORE_KEY) || '0', 10);
  let overlayOpen    = false;
  let quizSubmitted  = false;
  let lastLostAt     = 0;     // timestamp of last focus-loss event
  let pageFocused    = true;  // our own tracked state
  let pageReadyAt    = Date.now();

  /* ‚îÄ‚îÄ DOM refs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  const overlay      = document.getElementById('ac-overlay');
  const autoSubmitEl = document.getElementById('ac-autosubmit');
  const badge        = document.getElementById('ac-badge');
  const badgeText    = document.getElementById('ac-badge-text');
  const warningMsg   = document.getElementById('ac-warning-msg');
  const strikeMsg    = document.getElementById('ac-strike-msg');
  const dismissBtn   = document.getElementById('ac-dismiss');
  const answerForm   = document.getElementById('answer-form');

  /* ‚îÄ‚îÄ Persist & update badge ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function savePersist() {
    try { sessionStorage.setItem(STORE_KEY, String(strikes)); } catch(e) {}
  }

  function updateBadge() {
    if (strikes === 0) { badge.classList.add('hidden'); return; }
    badge.classList.remove('hidden');
    badgeText.textContent = strikes + ' / ' + MAX_STRIKES + ' strike' + (strikes !== 1 ? 's' : '');
    // pulse animation
    badge.classList.remove('scale-110');
    void badge.offsetWidth; // reflow
    badge.classList.add('scale-110');
    setTimeout(() => badge.classList.remove('scale-110'), 200);
  }

  // Restore badge on page load if there are existing strikes
  updateBadge();

  /* ‚îÄ‚îÄ Silent flag (no strike ‚Äî just logs to DB) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function silentFlag(type) {
    fetch('/api/cheat-flag/' + SESSION_ID, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ violation: type })
    }).catch(() => {});
  }

  /* ‚îÄ‚îÄ Strike flag (increments strike + logs) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function addStrike(type) {
    strikes++;
    savePersist();
    updateBadge();
    silentFlag(type);
  }

  /* ‚îÄ‚îÄ Core: lost focus handler (all detection paths funnel here) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function onFocusLost(source) {
    if (quizSubmitted) return;

    const now = Date.now();
    // Grace period: ignore events in the first GRACE_MS after page load
    if (now - pageReadyAt < GRACE_MS) return;
    // Debounce: visibilitychange + blur often fire together within ms of each other.
    // Only count ONE strike per DEBOUNCE_MS window.
    if (now - lastLostAt < DEBOUNCE_MS) return;

    lastLostAt   = now;
    pageFocused  = false;

    if (overlayOpen) {
      // Already showing ‚Äî just add another silent log, no extra strike
      silentFlag(source);
      return;
    }

    addStrike(source);

    if (strikes >= MAX_STRIKES) {
      autoSubmitQuiz();
      return;
    }

    // Show warning overlay
    overlayOpen = true;
    warningMsg.textContent = source === 'tab_switch'
      ? 'You switched to another tab or minimised the window.'
      : source === 'devtools'
        ? 'Developer tools were detected open.'
        : 'You left the quiz window.';
    strikeMsg.textContent =
      '‚ö†Ô∏è Strike ' + strikes + ' of ' + MAX_STRIKES +
      '. ' + (MAX_STRIKES - strikes) + ' more will auto-submit your quiz.';
    overlay.classList.remove('hidden');
    dismissBtn.focus();
  }

  /* ‚îÄ‚îÄ Dismiss overlay ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function dismissWarning() {
    overlay.classList.add('hidden');
    overlayOpen  = false;
    pageFocused  = true;
    lastLostAt   = Date.now(); // reset debounce after dismiss so re-focus doesn't re-trigger
  }
  dismissBtn.addEventListener('click', dismissWarning);

  /* ‚îÄ‚îÄ Auto-submit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function autoSubmitQuiz() {
    if (quizSubmitted) return;
    quizSubmitted = true;
    silentFlag('auto_submit');
    overlay.classList.add('hidden');
    autoSubmitEl.classList.remove('hidden');

    let secs = 5;
    document.getElementById('ac-countdown').textContent = secs;
    const iv = setInterval(() => {
      secs--;
      document.getElementById('ac-countdown').textContent = secs;
      if (secs <= 0) {
        clearInterval(iv);
        const expForm = document.getElementById('expire-form');
        if (expForm) {
          expForm.submit();
        } else {
          const f = document.createElement('form');
          f.method = 'POST';
          f.action = '/quiz/' + SESSION_ID + '/expire';
          document.body.appendChild(f);
          f.submit();
        }
      }
    }, 1000);
  }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     DETECTION LAYER 1 ‚Äî Page Visibility API
     Fires when tab is hidden (switch tab, minimise, etc.)
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) onFocusLost('tab_switch');
  });

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     DETECTION LAYER 2 ‚Äî Window blur
     Fires when another app / devtools panel steals focus,
     even without the tab becoming "hidden".
     Deduplicated by DEBOUNCE_MS so it doesn't double-count
     when both visibilitychange AND blur fire together.
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  window.addEventListener('blur', () => onFocusLost('window_blur'));

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     DETECTION LAYER 3 ‚Äî document.hasFocus() polling
     This is the most reliable cross-browser backstop.
     Catches cases where events are suppressed or missed.
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  setInterval(() => {
    if (quizSubmitted) return;
    const focused = document.hasFocus();
    if (!focused && pageFocused) {
      // State just changed to unfocused ‚Äî treat as a loss event
      onFocusLost('window_blur');
    }
    pageFocused = focused;
  }, POLL_MS);

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     DETECTION LAYER 4 ‚Äî DevTools size heuristic
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  let devtoolsWasOpen = false;
  setInterval(() => {
    if (quizSubmitted) return;
    const open = (window.outerWidth  - window.innerWidth  > 160) ||
                 (window.outerHeight - window.innerHeight > 160);
    if (open && !devtoolsWasOpen) {
      devtoolsWasOpen = true;
      onFocusLost('devtools');
    } else if (!open) {
      devtoolsWasOpen = false;
    }
  }, 1500);

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     KEYBOARD BLOCKING
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  document.addEventListener('keydown', e => {
    const ctrl  = e.ctrlKey || e.metaKey;
    const shift = e.shiftKey;
    const key   = e.key ? e.key.toUpperCase() : '';

    if (e.key === 'F12')                              { e.preventDefault(); silentFlag('devtools'); return; }
    if (ctrl && shift && ['I','J','C','K'].includes(key)) { e.preventDefault(); silentFlag('devtools'); return; }
    if (ctrl && key === 'U')                          { e.preventDefault(); silentFlag('keyboard_shortcut'); return; }
    if (ctrl && ['C','V','X','A'].includes(key))      { e.preventDefault(); silentFlag('copy_attempt'); return; }
    if (ctrl && key === 'P')                          { e.preventDefault(); silentFlag('keyboard_shortcut'); return; }
    if (ctrl && key === 'S')                          { e.preventDefault(); return; }
    if (ctrl && key === 'F')                          { e.preventDefault(); silentFlag('keyboard_shortcut'); return; }
    if (e.key === 'PrintScreen')                      { e.preventDefault(); silentFlag('keyboard_shortcut'); return; }
  });

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     COPY / PASTE / DRAG BLOCKING
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  ['copy','cut','paste'].forEach(evt =>
    document.addEventListener(evt, e => { e.preventDefault(); silentFlag('copy_attempt'); })
  );
  document.addEventListener('dragstart', e => e.preventDefault());
  document.addEventListener('contextmenu', e => { e.preventDefault(); silentFlag('right_click'); });
  document.addEventListener('selectstart', e => {
    if (['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
    e.preventDefault();
  });

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PRINT BLOCKING
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  window.addEventListener('beforeprint', e => { e.preventDefault(); silentFlag('keyboard_shortcut'); });

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     BEFOREUNLOAD WARNING
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  window.addEventListener('beforeunload', e => {
    if (quizSubmitted) return;
    e.preventDefault();
    e.returnValue = 'Leaving will interrupt your quiz. Your progress is saved.';
    return e.returnValue;
  });

  // Allow navigation when legitimately submitting an answer
  answerForm?.addEventListener('submit', () => { quizSubmitted = true; });

})();
</script>
{% endblock %}